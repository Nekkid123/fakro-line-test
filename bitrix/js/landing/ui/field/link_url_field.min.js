(function(){"use strict";BX.namespace("BX.Landing.UI.Field");var e=BX.Landing.Utils.isBoolean;var t=BX.Landing.Utils.isArray;var i=BX.Landing.Utils.isString;var n=BX.Landing.Utils.isEmpty;var s=BX.Landing.Utils.append;var a=BX.Landing.Utils.remove;var l=BX.Landing.Utils.data;var r=BX.Landing.Utils.attr;var o=BX.Landing.Utils.addClass;var h=BX.Landing.Utils.removeClass;var u=BX.Landing.Utils.proxy;var d=BX.Landing.Utils.htmlToElement;var c=BX.Landing.Utils.bind;var g=BX.Landing.Utils.unbind;var p=BX.Landing.Utils.join;var L=BX.Landing.Utils.fireEvent;var f=BX.Landing.Utils.hash;var y=BX.Landing.Utils.capitalize;var m=BX.Landing.Utils.style;var T=BX.Landing.UI.Button.BaseButton;var v=BX.Landing.UI.Field.Dropdown;var _=BX.Landing.UI.Tool.Menu;var B=BX.Landing.Cache;var E="block";var I="landing";var b="system";var S="catalog";var U="element";var k="section";var C="";var w="tel:";var P="skype:";var X="sms:";var N="mailto:";var R={catalog:new RegExp("^#catalog#(Element|Section)([0-9]+)"),catalogElement:new RegExp("^#catalogElement([0-9]+)"),catalogSection:new RegExp("^#catalogSection([0-9]+)"),block:new RegExp("^#block([0-9]+)"),page:new RegExp("^#landing([0-9]+)"),system:new RegExp("^#system_[a-z_-]+")};BX.Landing.UI.Field.LinkURL=function(i){BX.Landing.UI.Field.Text.apply(this,arguments);o(this.layout,"landing-ui-field-link-url");this.requestOptions=i.options||{};this.allowedTypes=t(i.allowedTypes)?i.allowedTypes:[E,I];this.disableBlocks=e(i.disableBlocks)?i.disableBlocks:false;this.disableCustomURL=e(i.disableCustomURL)?i.disableCustomURL:false;this.disallowType=e(i.disallowType)?i.disallowType:false;this.iblocks=t(i.iblocks)?i.iblocks:null;this.allowedCatalogEntityTypes=t(i.allowedCatalogEntityTypes)?i.allowedCatalogEntityTypes:null;this.onListShow=this.onListShow.bind(this,this.requestOptions);this.onSelectButtonClick=this.onSelectButtonClick.bind(this);this.onTypeChange=this.onTypeChange.bind(this);this.onListItemClick=this.onListItemClick.bind(this);this.popup=null;this.dynamic=null;this.value=null;this.button=this.createButton();this.hrefTypeSwithcer=this.createTypeSwitcher();this.grid=this.createGridLayout();this.gridLeftCell=this.grid.querySelector('[class*="left"]');this.gridCenterCell=this.grid.querySelector('[class*="center"]');this.gridRightCell=this.grid.querySelector('[class*="right"]');a(this.hrefTypeSwithcer.header);s(this.hrefTypeSwithcer.layout,this.gridLeftCell);s(this.input,this.gridCenterCell);s(this.button.layout,this.gridRightCell);s(this.grid,this.layout);this.setHrefPlaceholderByType(this.getHrefStringType());this.setHrefTypeSwitcherValue(this.getHrefStringType());this.removeHrefTypeFromHrefString();this.makeDisplayedHrefValue();if(this.disallowType){void m(this.gridLeftCell,{display:"none"})}};BX.Landing.UI.Field.LinkURL.TYPE_BLOCK=E;BX.Landing.UI.Field.LinkURL.TYPE_PAGE=I;BX.Landing.UI.Field.LinkURL.TYPE_CATALOG=S;BX.Landing.UI.Field.LinkURL.TYPE_CATALOG_ELEMENT=U;BX.Landing.UI.Field.LinkURL.TYPE_CATALOG_SECTION=k;BX.Landing.UI.Field.LinkURL.matchers=R;BX.Landing.UI.Field.LinkURL.prototype={constructor:BX.Landing.UI.Field.LinkURL,__proto__:BX.Landing.UI.Field.Text.prototype,makeDisplayedHrefValue:function(){var e=this.getValue();var t=this.getPlaceholderType();var i;switch(t){case E:i=this.getBlockData(e);break;case I:i=this.getPageData(e);break;case U:i=this.getCatalogElementData(e);break;case k:i=this.getCatalogSectionData(e);break;case b:i=this.getSystemPage(e);break}if(i){i.then(u(this.createPlaceholder,this)).then(u(this.setValue,this));this.disableHrefTypeSwitcher();this.setHrefTypeSwitcherValue(C)}this.enableHrefTypeSwitcher()},getPlaceholderData:function(e){e=e||this.getValue();var t=this.getPlaceholderType(e);var i=Promise.resolve({});switch(t){case E:i=this.getBlockData(e);break;case I:i=this.getPageData(e);break;case U:i=this.getCatalogElementData(e);break;case k:i=this.getCatalogSectionData(e);break;case b:i=this.getSystemPage(e);break}return i},removeHrefTypeFromHrefString:function(){var e=this.getValue().replace(new RegExp(this.getHrefStringType(),"g"),"");this.setValue(e,true)},setHrefTypeSwitcherValue:function(e){this.hrefTypeSwithcer.setValue(e)},disableHrefTypeSwitcher:function(){this.hrefTypeSwithcer.disable()},enableHrefTypeSwitcher:function(){this.hrefTypeSwithcer.enable()},getSelectedHrefType:function(){return this.hrefTypeSwithcer.getValue()},getHrefStringType:function(){var e=this.getValue().split(":")[0];var t=C;switch(p(e,":")){case w:t=w;break;case X:t=X;break;case P:t=P;break;case N:t=N;break}return t},setHrefPlaceholderByType:function(e){var t=this.placeholder||BX.message("FIELD_LINK_HREF_PLACEHOLDER");switch(e){case C:if(this.disableBlocks&&this.disableCustomURL){t=BX.message("FIELD_LINK_HREF_PLACEHOLDER_PAGES_ONLY")}if(!this.disableBlocks&&this.disableCustomURL){t=BX.message("FIELD_LINK_HREF_PLACEHOLDER_WITHOUT_CUSTOM_URL")}if(this.allowedTypes.length===1&&this.allowedTypes[0]===S){t=BX.message("FIELD_LINK_HREF_PLACEHOLDER_CATALOG_ONLY")}break;case w:t=BX.message("LANDING_LINK_FIELD_URL_TYPE_PHONE_PLACEHOLDER");break;case P:t=BX.message("LANDING_LINK_FIELD_URL_TYPE_SKYPE_PLACEHOLDER");break;case X:t=BX.message("LANDING_LINK_FIELD_URL_TYPE_SMS_PLACEHOLDER");break;case N:t=BX.message("LANDING_LINK_FIELD_URL_TYPE_EMAIL_PLACEHOLDER");break}l(this.input,"data-placeholder",t)},getPlaceholderType:function(e){e=e||this.getValue();if(R.block.test(e)){return E}if(R.page.test(e)){return I}if(R.catalogElement.test(e)){return U}if(R.catalogSection.test(e)){return k}if(R.system.test(e)){return b}return C},containsPlaceholder:function(){return this.input.innerHTML.indexOf("span")!==-1},createGridLayout:function(){return d('<div class="landing-ui-field-link-url-grid">'+'<div class="landing-ui-field-link-url-grid-left"></div>'+'<div class="landing-ui-field-link-url-grid-center"></div>'+'<div class="landing-ui-field-link-url-grid-right"></div>'+"</div>")},createTypeSwitcher:function(){return new v({items:[{name:BX.message("LANDING_LINK_FIELD_URL_TYPE_LINK"),value:C},{name:BX.message("LANDING_LINK_FIELD_URL_TYPE_PHONE"),value:w},{name:BX.message("LANDING_LINK_FIELD_URL_TYPE_SKYPE"),value:P},{name:BX.message("LANDING_LINK_FIELD_URL_TYPE_SMS"),value:X},{name:BX.message("LANDING_LINK_FIELD_URL_TYPE_EMAIL"),value:N}],onValueChange:this.onTypeChange})},createButton:function(){return new T("dropdown_button",{text:BX.message("LINK_URL_SUGGESTS_SELECT"),className:"landing-ui-button-select-link",onClick:this.onSelectButtonClick})},onTypeChange:function(e){var t=e.getValue();switch(t){case C:g(this.gridRightCell,"mouseover",u(this.onButtonMouseover,this));g(this.gridRightCell,"mouseout",u(this.onButtonMouseout,this));this.button.enable();break;case w:case X:case P:case N:c(this.gridRightCell,"mouseover",u(this.onButtonMouseover,this));c(this.gridRightCell,"mouseout",u(this.onButtonMouseout,this));this.button.disable();break}this.setHrefPlaceholderByType(t)},onButtonMouseover:function(){this.customTypeSuggestTimeout=setTimeout(function(){BX.Landing.UI.Tool.Suggest.getInstance().show(this.button.layout,{description:BX.message("LANDING_LINK_FIELD_URL_TYPE_CUSTOM_BUTTON_TITLE")});this.pulseTimeout=setTimeout(function(){o(this.hrefTypeSwithcer.input,"landing-ui-pulse")}.bind(this),1e3)}.bind(this),100)},onButtonMouseout:function(){clearTimeout(this.customTypeSuggestTimeout);BX.Landing.UI.Tool.Suggest.getInstance().hide();clearTimeout(this.pulseTimeout);h(this.hrefTypeSwithcer.input,"landing-ui-pulse")},getBlockData:function(e){if(B.has(f(e))){return Promise.resolve(B.get(f(e)))}var t=parseInt(e.replace("#block",""));return BX.Landing.UI.Panel.URLList.getInstance().getBlocks(null,this.requestOptions).then(function(i){var n=i.find(function(e){return t===e.id});var s={type:"block",id:n.id,name:n.name};B.set(f(e),s);return s})},getPageData:function(e){if(B.has(f(e))){return Promise.resolve(B.get(f(e)))}var t=parseInt(e.replace("#landing",""));return BX.Landing.UI.Panel.URLList.getInstance().getLanding(t,this.requestOptions).then(function(t){t=t[0];if(t){var i={type:"landing",id:t.ID,name:t.TITLE};B.set(f(e),i);return i}})},getSystemPage:function(e){if(B.has(f(e))){return Promise.resolve(B.get(f(e)))}var t=this.content.replace("#system_","");var i=BX.Landing.Main.getInstance().options.syspages;if(t in i){var n={type:"system",id:"_"+t,name:i[t].name};B.set(f(e),n);return Promise.resolve(n)}return Promise.reject()},getCatalogElementData:function(e){if(B.has(f(e))){return Promise.resolve(B.get(f(e)))}var t=e.match(R.catalogElement)[1];var i={elementId:t};return BX.Landing.Backend.getInstance().action("Utils::getCatalogElement",i).then(function(t){B.set(f(e),t);return t})},getCatalogSectionData:function(e){if(B.has(f(e))){return Promise.resolve(B.get(f(e)))}var t=e.match(R.catalogSection)[1];var i={sectionId:t};return BX.Landing.Backend.getInstance().action("Utils::getCatalogSection",i).then(function(t){B.set(f(e),t);return t})},createPopup:function(){var e=[];if(this.allowedTypes.includes(E)){e.push({text:BX.message("LANDING_LINKS_BUTTON_BLOCKS"),onclick:this.onListShow.bind(this,E)})}if(this.allowedTypes.includes(I)){e.push({text:BX.message("LANDING_LINKS_BUTTON_LANDINGS"),onclick:this.onListShow.bind(this,I)})}if(this.allowedTypes.includes(S)){e.push({text:BX.message("LANDING_LINKS_BUTTON_CATALOG"),onclick:this.onListShow.bind(this,S)})}this.popup=new _({id:"link_list_"+ +new Date,bindElement:this.button.layout,items:e,autoHide:true,events:{onPopupClose:this.button.deactivate.bind(this.button)}});s(this.popup.popupWindow.popupContainer,this.button.layout.parentNode);return this.popup},onSelectButtonClick:function(){if(this.allowedTypes.length===1&&this.allowedTypes[0]===S){this.onListShow(S);return}this.popup=this.popup||this.createPopup();this.button.enable();this.popup.show();var e=BX.pos(this.button.layout,this.button.layout.parentNode);this.popup.popupWindow.popupContainer.style.top=e.bottom+"px";this.popup.popupWindow.popupContainer.style.left="auto";this.popup.popupWindow.popupContainer.style.right="0"},onListShow:function(e,i){if(this.popup){this.popup.close()}if(i===S){var n=this.iblocks;if(!t(n)){n=BX.Landing.Main.getInstance().options.iblocks}void BX.Landing.UI.Panel.Catalog.getInstance().show(n,this.allowedCatalogEntityTypes).then(this.onListItemClick);return}void BX.Landing.UI.Panel.URLList.getInstance().show(i,e).then(this.onListItemClick)},isEditPrevented:function(){if(!e(this.editPrevented)){this.editPrevented=this.disableCustomURL||this.containsPlaceholder()}return this.editPrevented},setEditPrevented:function(e){this.editPrevented=e},enableEdit:function(){if(!this.isEditPrevented()&&!this.disableCustomURL){BX.Landing.UI.Field.Text.prototype.enableEdit.apply(this)}},createPlaceholder:function(e){var t=d('<span class="landing-ui-field-url-placeholder" title="'+e.name+'">'+'<span class="landing-ui-field-url-placeholder-preview"></span>'+'<span class="landing-ui-field-url-placeholder-text">'+e.name+"</span>"+'<span class="landing-ui-field-url-placeholder-delete"></span>'+"</span>");var s=t.querySelector('[class*="delete"]');c(s,"click",u(this.onPlaceholderRemoveClick,this));if(!n(e.image)&&i(e.image)){var a=t.querySelector('[class*="preview"]');r(a,{style:"background-image: url('"+e.image+"')"});if(e.subType===k){o(a,"section")}}if(e.type===S){e.chain.push(e.name);var l=p(e.name,"\n",e.chain.join(" / "));r(t,{"data-dynamic":{type:p(S,y(e.subType)),value:e.id},"data-placeholder":p("#",e.type,y(e.subType),e.id),title:l});return t}r(t,{"data-placeholder":p("#",e.type,e.id),title:e.name});return t},onPlaceholderRemoveClick:function(e){this.setEditPrevented(false);this.enableEdit();a(e.target.parentNode);this.setValue("");L(this.layout,"input");this.onInputHandler(this.input.innerText)},onListItemClick:function(e){this.setValue(this.createPlaceholder(e));this.disableHrefTypeSwitcher();this.setHrefTypeSwitcherValue(C);L(this.layout,"input")},setValue:function(e,t){if(typeof e==="object"){this.disableEdit();this.setEditPrevented(true);this.input.innerHTML="";s(e,this.input);this.value=e.dataset.placeholder;this.dynamic=e.dataset.dynamic;if(!t){this.onInputHandler(this.input.innerText)}}else{this.setEditPrevented(false);this.input.innerText=e.toString().trim();this.value=null;this.dynamic=null;this.enableHrefTypeSwitcher()}if(!t){this.onValueChangeHandler()}},getDynamic:function(){return this.dynamic},getValue:function(){return this.getSelectedHrefType()+(this.value?this.value:this.input.innerText)}}})();