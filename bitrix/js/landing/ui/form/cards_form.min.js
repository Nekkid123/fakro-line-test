(function(){"use strict";BX.namespace("BX.Landing.UI.Form");var e=BX.Landing.Utils.append;var n=BX.Landing.Utils.create;var t=BX.Landing.Utils.bind;var i=BX.Landing.Utils.unbind;var a=BX.Landing.Utils.proxy;var o=BX.Landing.Utils.addClass;var r=BX.Landing.Utils.removeClass;var s=BX.Landing.Utils.hasClass;var l=BX.Landing.Utils.style;var d=BX.Landing.Utils.slice;var p=BX.Landing.Utils.findParent;var u=BX.Landing.Utils.offsetTop;var c=BX.Landing.Utils.offsetLeft;var h=BX.Landing.Utils.rect;var m=BX.Landing.Utils.remove;var f=BX.Landing.Utils.onTransitionEnd;var g=BX.Landing.Utils.random;var v=BX.Landing.Utils.clone;var B=BX.Landing.Utils.isString;var L=BX.Landing.Utils.isArray;var C=BX.Landing.Utils.isEmpty;var y=BX.Landing.Utils.isPlainObject;var I=BX.Landing.Utils.join;var x=BX.Landing.Utils.onCustomEvent;var X=BX.Landing.UI.Collection.FormCollection;var E=BX.Landing.UI.Button.BaseButton;BX.Landing.UI.Form.CardsForm=function(n){BX.Landing.UI.Form.BaseForm.apply(this,arguments);this.layout.classList.add("landing-ui-form-cards");this.type="cards";this.code=n.code;this.presets=n.presets;this.childForms=new X;this.onItemClick=a(this.onItemClick,this);this.onRemoveItemClick=a(this.onRemoveItemClick,this);this.onRemoveItemMouseenter=a(this.onRemoveItemMouseenter,this);this.onRemoveItemMouseleave=a(this.onRemoveItemMouseleave,this);this.onAddCardClick=a(this.onAddCardClick,this);this.addButton=this.createAddButton();this.wheelEventName=this.getWheelEventName();setTimeout(function(){this.value=this.serialize()}.bind(this));this.adjustLastFormState();e(this.addButton.layout,this.footer)};function F(e,t){return n("div",{props:{className:"landing-ui-form-cards-item"},children:[n("div",{children:[n("div",{props:{className:"landing-ui-form-card-item-header"},events:{click:t.onItemClick},children:[n("div",{props:{className:"landing-ui-form-card-item-header-left"},children:[n("div",{props:{className:"landing-ui-form-card-item-header-left-inner"},children:[n("span",{props:{className:"landing-ui-form-card-item-header-drag landing-ui-drag"}}),n("span",{props:{className:"landing-ui-form-card-item-header-title"},children:[e.label]})]}),n("span",{props:{className:"landing-ui-form-card-item-header-edit"},children:[n("span",{props:{className:"fa fa-pencil"}})]})]}),n("div",{children:[n("span",{props:{className:"landing-ui-form-card-item-header-remove"},children:[n("span",{props:{className:"fa fa-remove"}})],events:{click:t.onRemoveItemClick,mouseenter:t.onRemoveItemMouseenter,mouseleave:t.onRemoveItemMouseleave}})]})]}),e.layout]})]})}function b(e,n){var i=e.querySelector(".landing-ui-form-card-item-header-drag");i.onbxdragstart=y.bind(this);i.onbxdrag=x.bind(this);i.onbxdragstop=X.bind(this);jsDD.registerObject(i);t(i,"mousedown",F);t(i,"mouseup",b);t(i,"click",E);var a=p(e,{className:"landing-ui-panel-content-body-content"});jsDD.setScrollWindow(a);var s;var c;var m;var f;var g;var v;var B;var L;var C;function y(){a=p(e,{className:"landing-ui-panel-content-body-content"});s=h(e);c=Math.max(Math.abs(jsDD.start_y-s.top),0);m=a.scrollTop;f=[].indexOf.call(d(e.parentElement.children),e);B=p(jsDD.current_node,{className:"landing-ui-form-cards-item"});var n=getComputedStyle(e);var t=parseInt(n.getPropertyValue("margin-top"));t=t===t?t:0;var i=parseInt(n.getPropertyValue("margin-bottom"));i=i===i?i:0;g=s.height+(t+i)/2;L=-u(B,B.parentElement);var o=h(B.parentElement);C=o.height-u(B,B.parentElement)-s.height}function x(n,t){var i=m-a.scrollTop;var o=t-s.top-c-i;o=Math.min(Math.max(o,L),C);l(e,{zIndex:999,transform:"translateY("+o+"px)"});d(e.parentElement.children).forEach(function(n,i){if(n!==e){var a=n.getBoundingClientRect();var o=a.top+BX.scrollTop(window)+a.height/2;if(i>f&&t>o&&n.style.transform!=="translate3d(0px, "+-g+"px, 0px)"&&n.style.transform!==""){v=n;l(n,{transform:"translate3d(0px, "+-g+"px, 0px)",transition:"300ms"})}if(i<f&&t<o&&n.style.transform!=="translate3d(0px, "+g+"px, 0px)"&&n.style.transform!==""){v=n;l(n,{transform:"translate3d(0px, "+g+"px, 0px)",transition:"300ms"})}if((i<f&&t>o||i>f&&t<o)&&n.style.transform!=="translate3d(0px, 0px, 0px)"){if(o>t){v=n.previousElementSibling}else{v=n.nextElementSibling}l(n,{transform:"translate3d(0px, 0px, 0px)",transition:"300ms"})}}})}function X(){d(e.parentElement.children).forEach(function(e){l(e,{zIndex:null,transform:null,transition:null});setTimeout(function(){r(e,"landing-ui-form-card-item-draggable")},50)});if(B&&v&&B!==v&&B.parentNode===v.parentNode){var t=[].indexOf.call(v.parentElement.children,B);var i=[].indexOf.call(v.parentElement.children,v);if(v.parentElement.children.length===i){v.parentElement.appendChild(target)}if(t>i){v.parentElement.insertBefore(B,v)}if(t<i&&v.parentElement.children.length!==i){v.parentElement.insertBefore(B,v.nextElementSibling)}}n.childForms.forEach(function(e){var n=[].indexOf.call(e.layout.parentElement.parentElement.parentElement.children,e.layout.parentElement.parentElement);e.oldIndex=N(e.selector);e.selector=I(e.selector.split("@")[0],"@",n)});n.childForms.sort(function(e,n){return parseInt(e.selector.split("@")[1])<parseInt(n.selector.split("@")[1])?-1:1})}function E(e){e.preventDefault();e.stopPropagation()}function F(){o(e,"landing-ui-form-card-item-draggable")}function b(){r(e,"landing-ui-form-card-item-draggable")}}function w(e){var t=[];if(B(e.labelBindings)){t.push(e.labelBindings)}else if(L(e.labelBindings)){t=t.concat(e.labelBindings)}e.fields.forEach(function(e){e.layout.hidden=true;e.reset();e.layout.hidden=false});t.forEach(function(t){var i=e.fields.find(function(e){return e.selector.split("@")[0]===t});if(i){var a=p(e.layout,{className:"landing-ui-form-cards-item"});var o;if(i instanceof BX.Landing.UI.Field.Link){o=a.querySelector(".landing-card-title-link");o.innerHTML=BX.message("LANDING_CARDS_FORM_ITEM_PLACEHOLDER_TEXT");x(i,"BX.Landing.UI.Field:change",function(e){o.innerHTML=e.text});return}if(i instanceof BX.Landing.UI.Field.Icon){o=a.querySelector(".landing-card-title-icon").firstElementChild;o.className="landing-card-title-icon";x(i,"BX.Landing.UI.Field:change",function(e){o.className="landing-card-title-icon "+e.classList.join(" ")});return}if(i instanceof BX.Landing.UI.Field.Image){o=a.querySelector(".landing-card-title-img");o.style.backgroundColor="#fafafa";o.innerHTML="";x(i,"BX.Landing.UI.Field:change",function(e){o.innerHTML="";o.appendChild(n("img",{props:{src:e.src}}))});return}if(i instanceof BX.Landing.UI.Field.Text){o=a.querySelector(".landing-card-title-text");x(i,"BX.Landing.UI.Field:change",function(e){o.innerHTML=e});o.innerHTML=BX.message("LANDING_CARDS_FORM_ITEM_PLACEHOLDER_TEXT")}}})}function U(e){return B(e)?e.split("@")[0]:""}function N(e){return B(e)?e.split("@")[1]:""}function M(e,n){return I(e.split("@")[0],"@",n)}BX.Landing.UI.Form.CardsForm.prototype={constructor:BX.Landing.UI.Form.CardsForm,__proto__:BX.Landing.UI.Form.BaseForm.prototype,getWheelEventName:function(){return!!window.onwheel?"wheel":"mousewheel"},createAddButton:function(){return new E("add-card-"+g(),{className:"landing-ui-card-add-button",text:BX.message("LANDING_CARDS_FORM_ADD_BUTTON"),onClick:this.onAddCardClick})},onItemClick:function(e){e.preventDefault();var n=p(e.currentTarget,{className:"landing-ui-form-cards-item"});if(!s(n,"landing-ui-form-card-item-draggable")){if(!s(n,"landing-ui-form-cards-item-expand")){o(n,"landing-ui-form-cards-item-expand");f(n).then(function(){l(n,{overflow:"visible"})});l(n,{height:n.firstChild.clientHeight+"px"})}else{r(n,"landing-ui-form-cards-item-expand");l(n,null)}}},onRemoveItemClick:function(e){e.stopPropagation();if(this.body.children.length>1){var n=p(e.currentTarget,{className:"landing-ui-form-cards-item"});m(n);var t=n.querySelector(".landing-ui-form-card");var i=this.childForms.find(function(e){return e.layout===t});this.childForms.remove(i)}this.adjustLastFormState()},onRemoveItemMouseenter:function(e){e.stopPropagation();e.preventDefault();var n=p(e.currentTarget,{className:"landing-ui-form-card-item-header"});o(n,"landing-ui-form-card-item-header-onremove")},onRemoveItemMouseleave:function(e){var n=p(e.currentTarget,{className:"landing-ui-form-card-item-header"});r(n,"landing-ui-form-card-item-header-onremove")},addChildForm:function(n){this.childForms.add(n);var t=F(n,this);e(t,this.body);b(t,this);this.adjustLastFormState()},onAddCardClick:function(){if(y(this.presets)&&!C(this.presets)){this.showPresetsPopup()}else{this.addEmptyCard()}},onPresetItemClick:function(e){var n=this.presets[e];var t=this.childForms[0].clone();t.selector=I(t.selector.split("@")[0],"@",this.childForms.length);t.oldIndex=this.childForms.length;t.preset=v(n);t.preset.id=e;this.addChildForm(t);w(t);this.adjustLastFormState();this.popup.close();if(y(n.values)){t.fields.forEach(function(e){var t=e.selector.split("@")[0];if(t in n.values){e.setValue(n.values[t]);if(e instanceof BX.Landing.UI.Field.Text){BX.fireEvent(e.input,"input")}}if(L(n.disallow)){var i=!!n.disallow.find(function(e){return t===e});if(i){e.layout.hidden=true}}})}},showPresetsPopup:function(){if(!this.popup){this.popup=new BX.Landing.UI.Tool.Menu({id:"catalog_blocks_list",bindElement:this.addButton.layout,items:Object.keys(this.presets).map(function(e){return{text:this.presets[e].name,className:"landing-ui-form-cards-preset-popup-item menu-popup-no-icon",onclick:this.onPresetItemClick.bind(this,e)}},this),autoHide:true,maxHeight:176});this.popup.layout.menuContainer.style.height="116px";this.popup.popupWindow.contentContainer.style.overflowX="hidden";t(this.popup.popupWindow.popupContainer,"mouseover",this.onMouseOver.bind(this));t(this.popup.popupWindow.popupContainer,"mouseleave",this.onMouseLeave.bind(this));t(top.document,"click",this.onDocumentClick.bind(this));e(this.popup.popupWindow.popupContainer,p(this.addButton.layout,{className:"landing-ui-panel-content-body-content"}))}if(this.popup.popupWindow.isShown()){this.popup.popupWindow.close()}else{this.popup.popupWindow.show()}this.adjustPopupPosition()},onMouseOver:function(){t(this.popup.popupWindow.popupContainer,this.wheelEventName,this.onMouseWheel.bind(this));t(this.popup.popupWindow.popupContainer,"touchmove",this.onMouseWheel.bind(this))},onMouseLeave:function(){i(this.popup.popupWindow.popupContainer,this.wheelEventName,this.onMouseWheel.bind(this));i(this.popup.popupWindow.popupContainer,"touchmove",this.onMouseWheel.bind(this))},onMouseWheel:function(e){e.stopPropagation();e.preventDefault();var n=BX.Landing.UI.Panel.Content.getDeltaFromEvent(e);var t=this.popup.popupWindow.contentContainer.scrollTop;requestAnimationFrame(function(){this.popup.popupWindow.contentContainer.scrollTop=t-n.y}.bind(this))},onDocumentClick:function(){if(this.popup.popupWindow){this.popup.popupWindow.close()}},adjustPopupPosition:function(){if(this.popup.popupWindow){requestAnimationFrame(function(){var e=p(this.addButton.layout,{className:"landing-ui-panel-content-body-content"});var n=u(this.addButton.layout,e);var t=c(this.addButton.layout,e);var i=this.addButton.layout.getBoundingClientRect();var a=this.popup.popupWindow.popupContainer.getBoundingClientRect();var o=14;this.popup.popupWindow.popupContainer.style.top=n+i.height+o+"px";this.popup.popupWindow.popupContainer.style.left=t-a.width/2+i.width/2+"px";this.popup.popupWindow.setAngle({offset:83,position:"top"})}.bind(this))}},addEmptyCard:function(){var e=this.childForms[0].clone();e.oldIndex=this.childForms.length;e.selector=I(e.selector.split("@")[0],"@",this.childForms.length);this.addChildForm(e);w(e);this.adjustLastFormState()},adjustLastFormState:function(){if(this.body.children.length===1){o(this.body.firstElementChild,"landing-ui-disallow-remove");return}d(this.body.children).forEach(function(e){r(e,"landing-ui-disallow-remove")})},serialize:function(){return this.childForms.map(function(e){return e.serialize()})},getIndexesMap:function(){return this.childForms.reduce(function(e,n,t){return e[t]=n.oldIndex,e},{})},getUsedPresets:function(){return this.childForms.reduce(function(e,n){if(y(n.preset)){e[N(n.selector)]=n.preset.id}return e},{})},isChanged:function(){return JSON.stringify(this.value)!==JSON.stringify(this.serialize())}}})();